#!/usr/bin/env python
import os
import pathlib
import shutil

import jinja2
from ruamel.yaml import YAML  # type: ignore

print("Building..")


def get_yaml() -> YAML:
    yaml = YAML(typ="safe")
    yaml.default_flow_style = False
    return yaml


yaml = get_yaml()

project_root = pathlib.Path(os.environ["PROJECT_ROOT"])
web_dir = project_root / "web"
build_dir = project_root / "ignore" / "dist"
build_dir.mkdir(exist_ok=True, parents=True)

events_file = project_root / "events.yaml"
events = yaml.load(events_file)

for static in {"style.css", "logo.svg"}:
    shutil.copy(web_dir / static, build_dir)

jinja_env = jinja2.Environment(loader=jinja2.FileSystemLoader(web_dir))

for page in {"index.html", "about.html", "code-of-conduct.html"}:
    dest_file = build_dir / page
    rendered = jinja_env.get_template(page).render(
        events=events, active_page=page
    )
    dest_file.write_text(rendered)

print("Done.")
